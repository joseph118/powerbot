import org.powerbot.script.rt6.ClientContext;
import org.powerbot.script.rt6.Npc;

/**
 * Created by Joseph18 on 12/5/2014.
 */
public class Talk extends Task<ClientContext> {
    int npcID;
    int healthPercentageToHeal;

    //curMaxStrings[0] is the current health
    //curMaxStrings[1] is the max health
    private final String[] curMaxStrings = ctx.widgets.component(1430, 4).component(7).text().split("/");
    private int currentHealth;
    private int healthPercentage;



    public Talk (ClientContext ctx, int npcID, int setHealthPercentageToHeal){
        super(ctx);
        this.npcID = npcID;
        this.healthPercentageToHeal = setHealthPercentageToHeal;
    }

    @Override
    public boolean activate() {
        currentHealth = (ctx.varpbits.varpbit(659) & 0xFFFF) >>> 1;
        healthPercentage = (((currentHealth) * 100) / Integer.valueOf(curMaxStrings[1]));
        return !(ctx.players.local().interacting().valid())
                && healthPercentage < healthPercentageToHeal
                && !ctx.players.local().inCombat()
                && !ctx.chat.queryContinue()
                && ctx.chat.get().isEmpty();
    }

    @Override
    public void execute() {
        System.out.println("Talking to NPC");
        Functions x = new Functions();
        Npc npc = ctx.npcs.select().select(x.nonCombatFilter).id(npcID).nearest().poll();
        if (npc.inViewport()) {
            npc.interact("Talk-to");
        } else {
            ctx.camera.turnTo(npc);
            ctx.movement.step(npc);
        }
    }

}
